<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kcc.vacation.domain.vacationrequest.mapper.VacationRequestMapper">

    <!-- 결과 매핑을 위한 resultMap 정의 -->
    <resultMap id="VacationRequestDetailResultMap" type="VacationRequestList">
        <id column="id" property="id" />
        <result column="reg_date" property="regDate" />
        <result column="started_date" property="startedDate" />
        <result column="end_date" property="endDate" />
        <result column="file_path" property="filePath" />
        <result column="approve_date" property="approveDate" />
        <result column="status" property="status" />
        <result column="comments" property="comments" />
        <result column="type_id" property="typeId" />
        <result column="emp_id" property="empId" />
        <result column="name" property="name" />
    </resultMap>

    <resultMap id="MyVacationsResultMap" type="MyVacation">
        <id column="id" property="vacationId"/>
        <result column="started_date" property="start"/>
        <result column="end_date" property="end"/>
        <result column="approve_date" property="approvedDate"/>
        <result column="status" property="status"/>
        <result column="name" property="title"/>
        <result column="vacation_days" property="vacationDays"/>
    </resultMap>

    <!-- 모든 휴가 요청 조회 -->
    <select id="getVacationList" resultMap="VacationRequestDetailResultMap">
        SELECT
            v.id,
            v.reg_date,
            v.started_date,
            v.end_date,
            v.file_path,
            v.approve_date,
            v.status,
            v.comments,
            v.type_id,
            v.emp_id,
            e.name
        FROM Vacation_request v, Employee e
        WHERE v.emp_id = e.id
    </select>

    <select id="getMyVacations" resultMap="MyVacationsResultMap">
        SELECT vr.id, vr.started_date, vr.end_date, vr.approve_date, vr.status, vt.name, e.vacation_days
        FROM employee e
                 JOIN vacation_request vr
                      ON e.id = vr.emp_id
                 JOIN vacation_type vt
                      ON vr.type_id = vt.id
        WHERE e.id = #{employeeId}
    </select>

    <insert id="insertVacationRequest" parameterType="MyVacationRequest">
        <selectKey keyProperty="id" resultType="int" order="BEFORE">
            SELECT vacation_request_seq.nextval FROM dual
        </selectKey>
        INSERT INTO vacation_request (id, reg_date, started_date, end_date, file_path, approve_date, status, comments,
        type_id, emp_id)
        VALUES (
        #{id},
        systimestamp,
        #{startedDate,jdbcType=TIMESTAMP},
        #{endedDate,jdbcType=TIMESTAMP},
        #{filePath, jdbcType=VARCHAR},
        #{approveDate,jdbcType=TIMESTAMP},
        #{status, jdbcType=VARCHAR},
        #{comments, jdbcType=VARCHAR},
        #{typeId},
        #{empId})
    </insert>

    <insert id="insertApprover" parameterType="MyVacationApprover">
        INSERT INTO approver(id, top_approver, first_approver, second_approver)
        VALUES (#{id}, #{topApprover}, #{firstApprover}, #{secondApprover})
    </insert>

</mapper>